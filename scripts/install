#!/bin/bash

# causes the shell to exit if any subcommand or pipeline returns a non-zero status
set -e

# TODO check for debain version and arch
# app will only run on one debian 64bit and download packages according to the version
read -d . VERSION < /etc/debian_version
case "$VERSION" in
	7) DOWNLOADURL=http://download.zarafa.com/zarafa/drupal/download_platform.php?platform=final/7.2/7.2.1-51838/zcp-7.2.1-51838-debian-7.0-x86_64-supported.tar.gz;;
	8) DOWNLOADURL=http://download.zarafa.com/zarafa/drupal/download_platform.php?platform=final/7.2/7.2.1-51838/zcp-7.2.1-51838-debian-8.0-x86_64-supported.tar.gz;;
esac

if [ $(uname -m) != "x86_64" ] ; then
exit 1
fi 

app=zarafa

# Retrieve arguments
path=$1

# Check domain/path availability
# sudo yunohost app checkurl $path -a $app \
#	|| (echo "Path not available: $path" && exit 1)

# TODO download and install zarafa packages
mkdir -p /home/admin/packages \
        && wget --no-check-certificate --quiet \
        $DOWNLOADURL -O- | tar xz -C /home/admin/packages --strip-components=1
cd /home/admin/packages
apt-ftparchive packages . | gzip -9c > Packages.gz && sudo sh -c 'echo "deb file:/home/admin/packages ./" > /etc/apt/sources.list.d/zarafa.list'

# Create password
db_pwd=$(openssl rand -hex 15)

#Use 'zarafa' as database name and user
db_user=$app

#Initialize database and store mysql password for upgrade
sudo yunohost app initdb $da_user -p $db_pwd
sudo yunohost app setting $app mysqlpwd -v $db_pwd

# TODO set mysql password in server.cfg
sed -i "s@mysqlpwd@$db_pwd@g" ../conf/server.cfg
sudo cp ../conf/server.cfg /etc/zarafa/
sudo cp ../conf/ldap.cfg /etc/zarafa/

# Modify Nginx configuration file and copy it to Nginx conf directory
sed -i "s@YNH_WWW_PATH@$path@g" ../conf/nginx.conf
sed -i "s@YNH_WWW_ALIAS@$final_path/@g" ../conf/nginx.conf

# Copy source files
# TODO change location of WebApp to the value given in $path
sudo cp ../conf/nginx.conf /etc/nginx/conf.d/$app.conf

# Restart webserver
sudo service nginx reload
sudo yunohost app ssowatconf
