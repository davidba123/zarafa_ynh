#!/bin/bash

# causes the shell to exit if any subcommand or pipeline returns a non-zero status
set -e

app=zarafa

# Retrieve arguments
path=$1
domain=$2

# Check distribution. Only Debian 7 & 8 are supported.
read -d . VERSION < /etc/debian_version
case "$VERSION" in
	7) DOWNLOADURL=http://download.zarafa.com/zarafa/drupal/download_platform.php?platform=final/7.2/7.2.1-51838/zcp-7.2.1-51838-debian-7.0-x86_64-supported.tar.gz;;
	8) DOWNLOADURL=http://download.zarafa.com/zarafa/drupal/download_platform.php?platform=final/7.2/7.2.1-51838/zcp-7.2.1-51838-debian-8.0-x86_64-supported.tar.gz;;
	*) echo "Your Distribution is not supported by this app!"; exit 1 ;;
esac

# check architecture. Only 64bit is supported.
if [ $(uname -m) != "x86_64" ] ; then
	echo "Your architecture is not supported by this app!"
	exit 1
fi 

# Check domain/path availability
# sudo yunohost app checkurl $path -a $app \
#	|| (echo "Path not available: $path" && exit 1)

# download and install zarafa packages
createrepo(){
	DOWNLOADURL=$1
	mkdir -p /home/admin/packages \
	&& wget --no-check-certificate --quiet \
	$DOWNLOADURL -O- | tar xz -C /home/admin/packages --strip-components=1
	cd /home/admin/packages
	apt-ftparchive packages . | gzip -9c > Packages.gz \
	&& sudo sh -c 'echo "deb file:/home/admin/packages ./" > /etc/apt/sources.list.d/zarafa.list'
cd -
}
createrepo $DOWNLOADURL
sudo apt-get update && RUNLEVEL=1 sudo apt-get install --allow-unauthenticated --assume-yes \
zarafa-server zarafa-spooler zarafa-dagent

# debug output to get current dir
echo $PWD

# Define database user and create password
db_user=zarafa
db_pwd=$(dd if=/dev/urandom bs=1 count=200 2> /dev/null | tr -c -d '[A-Za-z0-9]' | sed -n 's/\(.\{24\}\).*/\1/p')

#Initialize database and store mysql password for upgrade
sudo yunohost app initdb $db_user -p $db_pwd
# sudo yunohost app setting $app mysqlpwd -v $db_pwd

# TODO set mysql password in server.cfg
sed -i "s@mysqlpwd@$db_pwd@g" ../conf/server.cfg
sudo cp ../conf/server.cfg /etc/zarafa/
sudo cp ../conf/ldap.cfg /etc/zarafa/

final_path=/usr/share/zarafa-webapp

# Modify Nginx configuration file and copy it to Nginx conf directory
sed -i "s@YNH_WWW_PATH@$path@g" ../conf/nginx.conf
sed -i "s@YNH_WWW_ALIAS@$final_path/@g" ../conf/nginx.conf

# Copy source files
# TODO change location of WebApp to the value given in $path
sudo cp ../conf/nginx.conf /etc/nginx/conf.d/$app.conf

# Restart webserver
sudo service nginx reload
sudo yunohost app ssowatconf
